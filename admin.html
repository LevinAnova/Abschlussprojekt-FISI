<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VW Ausbildung - Admin</title>
    <link rel="stylesheet" href="style/admin-styles.css">
    <script src="js/cms.js" defer></script>

</head>

<body>
    <header>
        <div class="header-container container">
            <img src="img/vwlogo.png" alt="Volkswagen Logo" class="logo">
            <h1 class="header-title">Ausbildungsberufe - Administration</h1>
        </div>
    </header>

    <main class="container">
        <!-- Navigation Tabs -->
        <ul class="tabs" id="adminTabs">
            <li class="tab-item active" data-tab="categories">Kategorien</li>
            <li class="tab-item" data-tab="professions">Ausbildungsberufe</li>
        </ul>

        <!-- Kategorien-Verwaltung -->
        <section id="categoriesSection" class="content-section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Kategorien verwalten</h2>
                    <button id="addCategoryBtn" class="btn btn-primary btn-sm">Neue Kategorie</button>
                </div>
                <div class="card-body">
                    <div id="categoryAlert" class="alert" style="display: none;"></div>
                    <table class="table" id="categoriesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesList">
                            <!-- Kategorien werden hier eingef√ºgt -->
                            <tr>
                                <td colspan="3">Kategorien werden geladen...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Berufe-Verwaltung -->
        <section id="professionsSection" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ausbildungsberufe verwalten</h2>
                    <button id="addProfessionBtn" class="btn btn-primary btn-sm">Neuer Beruf</button>
                </div>
                <div class="card-body">
                    <div id="professionAlert" class="alert" style="display: none;"></div>
                    <table class="table" id="professionsTable">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Kategorie</th>
                                <th>Ausbildungsdauer</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="professionsList">
                            <!-- Berufe werden hier eingef√ºgt -->
                            <tr>
                                <td colspan="4">Berufe werden geladen...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modals -->
        <!-- Kategorie Modal -->
        <div class="modal-overlay" id="categoryModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="categoryModalTitle">Kategorie hinzuf√ºgen</h3>
                    <button class="modal-close" id="closeCategoryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="form-group">
                            <label for="categoryId" class="form-label">ID (Kurzname/Slug)</label>
                            <input type="text" id="categoryId" class="form-control" required>
                            <small>Nur Kleinbuchstaben, Zahlen und Bindestriche, z.B. "it-elektronik"</small>
                        </div>
                        <div class="form-group">
                            <label for="categoryName" class="form-label">Name</label>
                            <input type="text" id="categoryName" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelCategoryBtn">Abbrechen</button>
                    <button class="btn btn-primary" id="saveCategoryBtn">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Beruf Modal -->
        <div class="modal-overlay" id="professionModal">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="professionModalTitle">Ausbildungsberuf hinzuf√ºgen</h3>
                    <button class="modal-close" id="closeProfessionModal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Tabs f√ºr die verschiedenen Abschnitte -->
                    <div class="form-tabs">
                        <div class="form-tab active" data-section="general">Allgemeine Infos</div>
                        <div class="form-tab" data-section="gallery">Galerie-Bilder</div>
                        <div class="form-tab" data-section="qrcode">QR-Code</div>
                        <div class="form-tab" data-section="quiz" id="quizTab" style="display: none;">Wissenstest</div>
                    </div>

                    <form id="professionForm">
                        <!-- Allgemeine Informationen -->
                        <div class="form-section active" id="generalSection">
                            <div class="form-group">
                                <label for="professionId" class="form-label">ID (Kurzname/Slug)</label>
                                <input type="text" id="professionId" class="form-control" required>
                                <small>Nur Kleinbuchstaben, Zahlen und Bindestriche, z.B. "fachinformatiker-si"</small>
                            </div>
                            <div class="form-group">
                                <label for="professionTitle" class="form-label">Titel</label>
                                <input type="text" id="professionTitle" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="professionCategory" class="form-label">Kategorie</label>
                                <select id="professionCategory" class="form-control" required>
                                    <!-- Kategorien werden hier eingef√ºgt -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="professionDuration" class="form-label">Ausbildungsdauer</label>
                                <input type="text" id="professionDuration" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="professionDescription" class="form-label">Beschreibung</label>
                                <textarea id="professionDescription" class="form-control" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anforderungen</label>
                                <div class="list-manager" id="requirementsManager">
                                    <div id="requirementsList">
                                        <!-- Anforderungen werden hier eingef√ºgt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newRequirement"
                                            placeholder="Neue Anforderung hinzuf√ºgen">
                                        <button type="button" class="btn btn-secondary"
                                            id="addRequirementBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Karrierem√∂glichkeiten</label>
                                <div class="list-manager" id="careerOptionsManager">
                                    <div id="careerOptionsList">
                                        <!-- Karrierem√∂glichkeiten werden hier eingef√ºgt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newCareerOption"
                                            placeholder="Neue Karrierem√∂glichkeit hinzuf√ºgen">
                                        <button type="button" class="btn btn-secondary"
                                            id="addCareerOptionBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Standorte</label>
                                <div class="list-manager" id="locationsManager">
                                    <div id="locationsList">
                                        <!-- Standorte werden hier eingef√ºgt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newLocation"
                                            placeholder="Neuen Standort hinzuf√ºgen">
                                        <button type="button" class="btn btn-secondary" id="addLocationBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" id="hasKnowledgeTest"> Hat Wissenstest
                                </label>
                            </div>
                        </div>

                        <!-- Galerie-Bilder -->
                        <div class="form-section" id="gallerySection">
                            <div class="form-group">
                                <label class="form-label">Galerie-Bilder hochladen</label>
                                <div class="upload-area" id="galleryUploadArea">
                                    <div class="upload-icon">üì∏</div>
                                    <p>Klicken Sie hier, um Bilder hochzuladen<br>oder ziehen Sie Bilder hierher</p>
                                    <p class="file-info">Maximal 5MB pro Datei. Erlaubte Formate: JPG, PNG, GIF</p>
                                    <input type="file" id="imageUpload" accept="image/*">
                                </div>
                                <div id="uploadProgress" style="display: none;">
                                    <div class="spinner"></div> <span>Bild wird hochgeladen...</span>
                                </div>
                            </div>

                            <div id="galleryImagesContainer" class="gallery-preview">
                                <!-- Gallerie-Bilder werden hier angezeigt -->
                                <div id="noImagesMessage"
                                    style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #777;">
                                    Keine Bilder vorhanden. Laden Sie Bilder hoch, um sie in der Galerie anzuzeigen.
                                </div>
                            </div>
                        </div>

                        <!-- QR-Code -->
                        <div class="form-section" id="qrcodeSection">
                            <div class="form-group">
                                <label class="form-label">QR-Code f√ºr Bewerbungslink</label>
                                <div class="upload-area" id="qrUploadArea">
                                    <div class="upload-icon">üîó</div>
                                    <p>Klicken Sie hier, um einen QR-Code hochzuladen<br>oder ziehen Sie die Datei
                                        hierher</p>
                                    <p class="file-info">Maximal 5MB. Erlaubte Formate: JPG, PNG, SVG</p>
                                    <input type="file" id="qrUpload" accept="image/*">
                                </div>
                                <div id="qrUploadProgress" style="display: none;">
                                    <div class="spinner"></div> <span>QR-Code wird hochgeladen...</span>
                                </div>
                            </div>

                            <div id="qrPreview" class="qr-preview" style="display: none;">
                                <h4 style="text-align: center; margin-bottom: 10px;">Vorschau:</h4>
                                <img id="qrPreviewImage" src="" alt="QR-Code Vorschau">
                                <button id="removeQrBtn" class="btn btn-danger btn-sm"
                                    style="display: block; margin: 10px auto 0;">QR-Code entfernen</button>
                            </div>
                            <div id="noQrMessage" style="text-align: center; padding: 20px; color: #777;">
                                Kein QR-Code vorhanden. Laden Sie einen QR-Code hoch, um einen Bewerbungslink
                                anzubieten.
                            </div>
                        </div>

                        <div class="form-section" id="quizSection">
                            <div class="form-group">
                                <h3 class="form-label">Wissenstest erstellen</h3>
                                <p class="info-text">Hier k√∂nnen Sie bis zu 5 Fragen mit je 4 Antwortm√∂glichkeiten
                                    festlegen. Markieren Sie jeweils die richtige Antwort.</p>

                                <div id="quizQuestions">
                                    <!-- Fragen werden dynamisch eingef√ºgt -->
                                </div>

                                <button type="button" id="addQuestionBtn" class="btn btn-secondary mt-3"
                                    style="display: none;">Weitere Frage hinzuf√ºgen</button>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelProfessionBtn">Abbrechen</button>
                    <button class="btn btn-primary" id="saveProfessionBtn">Speichern</button>
                </div>
            </div>
        </div>
    </main>

    <template id="questionTemplate">
        <div class="quiz-question card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="question-title mb-0">Frage <span class="question-number">1</span></h4>
                <button type="button" class="btn btn-danger btn-sm delete-question">&times;</button>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Fragetext:</label>
                    <input type="text" class="form-control question-text" placeholder="Geben Sie hier Ihre Frage ein">
                </div>
                <div class="form-group mt-3">
                    <label>Erkl√§rung (wird nach Beantwortung angezeigt):</label>
                    <textarea class="form-control question-explanation" rows="2"
                        placeholder="Erkl√§rung zur richtigen Antwort"></textarea>
                </div>
                <div class="answer-options mt-3">
                    <label>Antwortoptionen:</label>
                    <div class="answer-option d-flex align-items-center mb-2">
                        <input type="radio" name="correct-1" class="correct-answer mr-2">
                        <input type="text" class="form-control answer-text" placeholder="Antwortoption 1">
                    </div>
                    <div class="answer-option d-flex align-items-center mb-2">
                        <input type="radio" name="correct-1" class="correct-answer mr-2">
                        <input type="text" class="form-control answer-text" placeholder="Antwortoption 2">
                    </div>
                    <div class="answer-option d-flex align-items-center mb-2">
                        <input type="radio" name="correct-1" class="correct-answer mr-2">
                        <input type="text" class="form-control answer-text" placeholder="Antwortoption 3">
                    </div>
                    <div class="answer-option d-flex align-items-center mb-2">
                        <input type="radio" name="correct-1" class="correct-answer mr-2">
                        <input type="text" class="form-control answer-text" placeholder="Antwortoption 4">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Variablen f√ºr den aktuellen State
            let categories = [];
            let professions = [];
            let currentMode = 'add'; // 'add' oder 'edit'
            let currentCategoryId = null;
            let currentProfessionId = null;
            let requirements = [];
            let careerOptions = [];
            let locations = [];
            let galleryImagesList = []; // Umbenannt von galleryImages zu galleryImagesList
            let qrCodeUrl = null;

            // DOM-Elemente
            const adminTabs = document.getElementById('adminTabs');
            const categoriesSection = document.getElementById('categoriesSection');
            const professionsSection = document.getElementById('professionsSection');
            const categoriesList = document.getElementById('categoriesList');
            const professionsList = document.getElementById('professionsList');
            const professionCategory = document.getElementById('professionCategory');

            // Modals
            const categoryModal = document.getElementById('categoryModal');
            const professionModal = document.getElementById('professionModal');

            // Forms
            const categoryForm = document.getElementById('categoryForm');
            const professionForm = document.getElementById('professionForm');

            // Buttons
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const addProfessionBtn = document.getElementById('addProfessionBtn');
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            const saveProfessionBtn = document.getElementById('saveProfessionBtn');
            const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
            const cancelProfessionBtn = document.getElementById('cancelProfessionBtn');
            const closeCategoryModal = document.getElementById('closeCategoryModal');
            const closeProfessionModal = document.getElementById('closeProfessionModal');
            const addRequirementBtn = document.getElementById('addRequirementBtn');
            const addCareerOptionBtn = document.getElementById('addCareerOptionBtn');
            const addLocationBtn = document.getElementById('addLocationBtn');

            // List containers
            const requirementsList = document.getElementById('requirementsList');
            const careerOptionsList = document.getElementById('careerOptionsList');
            const locationsList = document.getElementById('locationsList');

            // Alerts
            const categoryAlert = document.getElementById('categoryAlert');
            const professionAlert = document.getElementById('professionAlert');

            // Neue Elemente f√ºr Bilder und QR-Code
            const formTabs = document.querySelectorAll('.form-tab');
            const formSections = document.querySelectorAll('.form-section');
            const galleryUploadArea = document.getElementById('galleryUploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const qrUploadArea = document.getElementById('qrUploadArea');
            const qrUpload = document.getElementById('qrUpload');
            const galleryImagesContainer = document.getElementById('galleryImagesContainer');
            const qrPreview = document.getElementById('qrPreview');
            const qrPreviewImage = document.getElementById('qrPreviewImage');
            const noQrMessage = document.getElementById('noQrMessage');
            const removeQrBtn = document.getElementById('removeQrBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const qrUploadProgress = document.getElementById('qrUploadProgress');

            // Form-Tabs Funktionalit√§t
            formTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const activeTab = document.querySelector('.form-tab.active');
                    if (activeTab) {
                        activeTab.classList.remove('active');
                    }

                    this.classList.add('active');

                    const sectionName = this.dataset.section;
                    formSections.forEach(section => {
                        section.classList.remove('active');
                    });

                    document.getElementById(sectionName + 'Section').classList.add('active');
                });
            });

            // Tab-Wechsel
            adminTabs.addEventListener('click', function (e) {
                if (e.target.classList.contains('tab-item')) {
                    const activeTab = adminTabs.querySelector('.active');
                    if (activeTab) {
                        activeTab.classList.remove('active');
                    }

                    e.target.classList.add('active');

                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });

                    if (tabName === 'categories') {
                        categoriesSection.classList.add('active');
                    } else if (tabName === 'professions') {
                        professionsSection.classList.add('active');
                    }
                }
            });

            // Helfer-Funktionen f√ºr Modals
            function openModal(modal) {
                modal.classList.add('active');
            }

            function closeModal(modal) {
                modal.classList.remove('active');
            }

            // Kategorie-Modal √∂ffnen/schlie√üen
            addCategoryBtn.addEventListener('click', function () {
                currentMode = 'add';
                document.getElementById('categoryModalTitle').textContent = 'Kategorie hinzuf√ºgen';
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryId').disabled = false;
                document.getElementById('categoryName').value = '';
                openModal(categoryModal);
            });

            closeCategoryModal.addEventListener('click', function () {
                closeModal(categoryModal);
            });

            cancelCategoryBtn.addEventListener('click', function () {
                closeModal(categoryModal);
            });

            // Beruf-Modal √∂ffnen/schlie√üen
            addProfessionBtn.addEventListener('click', function () {
                currentMode = 'add';
                document.getElementById('professionModalTitle').textContent = 'Ausbildungsberuf hinzuf√ºgen';
                document.getElementById('professionId').value = '';
                document.getElementById('professionId').disabled = false;
                document.getElementById('professionTitle').value = '';
                document.getElementById('professionDescription').value = '';
                document.getElementById('professionDuration').value = '';
                document.getElementById('hasKnowledgeTest').checked = false;

                // Listen leeren
                requirements = [];
                careerOptions = [];
                locations = [];
                renderRequirements();
                renderCareerOptions();
                renderLocations();

                // Bilder und QR-Code zur√ºcksetzen
                renderGalleryImages([]);
                resetQrCode();

                // Zum ersten Tab wechseln
                document.querySelector('.form-tab.active').classList.remove('active');
                document.querySelector('.form-tab[data-section="general"]').classList.add('active');
                document.querySelector('.form-section.active').classList.remove('active');
                document.getElementById('generalSection').classList.add('active');

                // Kategorien laden
                loadCategoriesForSelect();

                openModal(professionModal);
            });

            closeProfessionModal.addEventListener('click', function () {
                closeModal(professionModal);
            });

            cancelProfessionBtn.addEventListener('click', function () {
                closeModal(professionModal);
            });

            // Listen-Manager
            addRequirementBtn.addEventListener('click', function () {
                const input = document.getElementById('newRequirement');
                if (input.value.trim()) {
                    requirements.push(input.value.trim());
                    renderRequirements();
                    input.value = '';
                }
            });

            addCareerOptionBtn.addEventListener('click', function () {
                const input = document.getElementById('newCareerOption');
                if (input.value.trim()) {
                    careerOptions.push(input.value.trim());
                    renderCareerOptions();
                    input.value = '';
                }
            });

            addLocationBtn.addEventListener('click', function () {
                const input = document.getElementById('newLocation');
                if (input.value.trim()) {
                    locations.push(input.value.trim());
                    renderLocations();
                    input.value = '';
                }
            });

            function renderRequirements() {
                requirementsList.innerHTML = '';
                requirements.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-requirement" data-index="${index}">&times;</button>
                        </div>
                    `;
                    requirementsList.appendChild(listItem);
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.delete-requirement').forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.dataset.index);
                        requirements.splice(index, 1);
                        renderRequirements();
                    });
                });
            }

            function renderCareerOptions() {
                careerOptionsList.innerHTML = '';
                careerOptions.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-career-option" data-index="${index}">&times;</button>
                        </div>
                    `;
                    careerOptionsList.appendChild(listItem);
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.delete-career-option').forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.dataset.index);
                        careerOptions.splice(index, 1);
                        renderCareerOptions();
                    });
                });
            }

            function renderLocations() {
                locationsList.innerHTML = '';
                locations.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-location" data-index="${index}">&times;</button>
                        </div>
                    `;
                    locationsList.appendChild(listItem);
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.delete-location').forEach(button => {
                    button.addEventListener('click', function () {
                        const index = parseInt(this.dataset.index);
                        locations.splice(index, 1);
                        renderLocations();
                    });
                });
            }

            function renderGalleryImages(images) {
                const galleryContainer = document.getElementById('galleryImagesContainer');
                const noImagesMessage = document.getElementById('noImagesMessage');

                if (!galleryContainer) {
                    console.error('Galerie-Container nicht gefunden!');
                    return;
                }

                if (!images || images.length === 0) {
                    galleryContainer.innerHTML = '';
                    if (noImagesMessage) {
                        noImagesMessage.style.display = 'block';
                    }
                    return;
                }

                if (noImagesMessage) {
                    noImagesMessage.style.display = 'none';
                }

                galleryContainer.innerHTML = '';

                images.forEach(image => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';

                    // Vollst√§ndige URL erstellen - stellen wir sicher, dass die URL korrekt ist
                    const imageUrl = image.url.startsWith('http') ? image.url :
                        image.url.startsWith('/') ? image.url : '/' + image.url;

                    galleryItem.innerHTML = `
                    <img src="${imageUrl}" alt="${image.alt_text || 'Galeriebild'}" 
                        onerror="this.src='/img/placeholder.jpg'; this.onerror=null;">
                    <button class="delete-btn" data-id="${image.id}">&times;</button>
                    `;
                    galleryContainer.appendChild(galleryItem);
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.gallery-item .delete-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const imageId = this.dataset.id;
                        if (confirm('M√∂chten Sie dieses Bild wirklich l√∂schen?')) {
                            deleteImage(imageId);
                        }
                    });
                });
            }

            async function deleteImage(imageId) {
                try {
                    await cmsApi.deleteImage(imageId);
                    const professionId = document.getElementById('professionId').value;
                    loadGalleryImages(professionId);
                    showAlert(professionAlert, 'Bild erfolgreich gel√∂scht.', 'success');
                } catch (error) {
                    console.error('Fehler beim L√∂schen des Bildes:', error);
                    showAlert(professionAlert, 'Fehler beim L√∂schen des Bildes: ' + error.message, 'danger');
                }
            }

            async function loadGalleryImages(professionId) {
                if (!professionId) {
                    console.warn('loadGalleryImages: Keine Berufs-ID angegeben');
                    renderGalleryImages([]);
                    return;
                }

                try {
                    console.log('Lade Galerie-Bilder f√ºr Beruf:', professionId);
                    const response = await fetch(`/api/professions/${professionId}`);

                    if (!response.ok) {
                        throw new Error(`Server-Fehler: ${response.status} ${response.statusText}`);
                    }

                    const profession = await response.json();
                    console.log('Geladene Berufsdetails:', profession);

                    if (profession && Array.isArray(profession.gallery_images)) {
                        console.log('Gefundene Galerie-Bilder:', profession.gallery_images.length);
                        renderGalleryImages(profession.gallery_images);
                    } else {
                        console.warn('Keine Galerie-Bilder gefunden f√ºr:', professionId);
                        renderGalleryImages([]);
                    }
                } catch (error) {
                    console.error('Fehler beim Laden der Bilder:', error);
                    renderGalleryImages([]);
                    showAlert(professionAlert, 'Fehler beim Laden der Bilder: ' + error.message, 'danger');
                }
            }

            function resetQrCode() {
                qrPreview.style.display = 'none';
                qrPreviewImage.src = '';
                noQrMessage.style.display = 'block';
            }

            async function loadQrCode(professionId) {
                try {
                    const profession = await cmsApi.getProfession(professionId);
                    if (profession.qr_code) {
                        qrPreviewImage.src = profession.qr_code;
                        qrPreview.style.display = 'block';
                        noQrMessage.style.display = 'none';
                    } else {
                        resetQrCode();
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des QR-Codes:', error);
                    resetQrCode();
                }
            }

            // Event-Listener f√ºr Bild-Upload
            galleryUploadArea.addEventListener('click', function () {
                imageUpload.click();
            });

            imageUpload.addEventListener('change', function () {
                if (this.files.length > 0) {
                    uploadGalleryImage(this.files[0]);
                }
            });

            // Drag & Drop f√ºr Gallerie-Bilder
            galleryUploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.style.borderColor = '#4cc0f1';
                this.style.backgroundColor = '#e6f7ff';
            });

            galleryUploadArea.addEventListener('dragleave', function () {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
            });

            galleryUploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';

                if (e.dataTransfer.files.length > 0) {
                    uploadGalleryImage(e.dataTransfer.files[0]);
                }
            });

            // Event-Listener f√ºr QR-Code-Upload hinzuf√ºgen
            qrUploadArea.addEventListener('click', function () {
                qrUpload.click();
            });

            qrUpload.addEventListener('change', function () {
                if (this.files.length > 0) {
                    uploadQrCode(this.files[0]);
                }
            });

            // Drag & Drop f√ºr QR-Code
            qrUploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.style.borderColor = '#4cc0f1';
                this.style.backgroundColor = '#e6f7ff';
            });

            qrUploadArea.addEventListener('dragleave', function () {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
            });

            qrUploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';

                if (e.dataTransfer.files.length > 0) {
                    uploadQrCode(e.dataTransfer.files[0]);
                }
            });

            // Event-Listener f√ºr QR-Code-Entfernen
            removeQrBtn.addEventListener('click', async function () {
                const professionId = document.getElementById('professionId').value;
                if (!professionId) {
                    showAlert(professionAlert, 'QR-Code kann nicht entfernt werden: Keine Berufs-ID vorhanden.', 'danger');
                    return;
                }

                if (confirm('M√∂chten Sie den QR-Code wirklich entfernen?')) {
                    try {
                        await cmsApi.deleteQrCode(professionId);
                        resetQrCode();
                        showAlert(professionAlert, 'QR-Code erfolgreich entfernt.', 'success');
                    } catch (error) {
                        console.error('Fehler beim Entfernen des QR-Codes:', error);
                        showAlert(professionAlert, 'Fehler beim Entfernen des QR-Codes: ' + error.message, 'danger');
                    }
                }
            });

            async function uploadGalleryImage(file) {
                const professionId = document.getElementById('professionId').value;
                if (!professionId) {
                    showAlert(professionAlert, 'Bitte speichern Sie zuerst den Beruf, bevor Sie Bilder hochladen.', 'danger');
                    return;
                }

                uploadProgress.style.display = 'block';

                try {
                    console.log('Starte Bild-Upload f√ºr Beruf:', professionId);
                    console.log('Datei:', file.name, file.size, 'Bytes');

                    // Formular f√ºr Datei-Upload erstellen
                    const formData = new FormData();
                    formData.append('file', file);

                    // Direkter Fetch-Aufruf zum API-Endpunkt
                    const response = await fetch(`/api/professions/${professionId}/images`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        // Versuche, die Fehlermeldung aus der Antwort zu extrahieren
                        let errorMessage;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || `Server-Fehler: ${response.status}`;
                        } catch (e) {
                            errorMessage = `Server-Fehler: ${response.status} ${response.statusText}`;
                        }

                        console.error('Fehler beim Bild-Upload:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('Bild-Upload erfolgreich:', result);

                    // Nach erfolgreichem Upload die Bilder neu laden
                    await loadGalleryImages(professionId);
                    showAlert(professionAlert, 'Bild erfolgreich hochgeladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Hochladen des Bildes:', error);
                    showAlert(professionAlert, 'Fehler beim Hochladen des Bildes: ' + error.message, 'danger');
                } finally {
                    uploadProgress.style.display = 'none';
                    imageUpload.value = ''; // Reset input
                }
            }

            async function uploadQrCode(file) {
                const professionId = document.getElementById('professionId').value;
                if (!professionId) {
                    showAlert(professionAlert, 'Bitte speichern Sie zuerst den Beruf, bevor Sie einen QR-Code hochladen.', 'danger');
                    return;
                }

                qrUploadProgress.style.display = 'block';

                try {
                    console.log('Starte QR-Code-Upload f√ºr Beruf:', professionId);
                    console.log('Datei:', file.name, file.size, 'Bytes');

                    // Formular f√ºr Datei-Upload erstellen
                    const formData = new FormData();
                    formData.append('file', file);

                    // Direkter Fetch-Aufruf zum API-Endpunkt f√ºr QR-Codes
                    const response = await fetch(`/api/professions/${professionId}/images/qr`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        // Versuche, die Fehlermeldung aus der Antwort zu extrahieren
                        let errorMessage;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorData.message || `Server-Fehler: ${response.status}`;
                        } catch (e) {
                            errorMessage = `Server-Fehler: ${response.status} ${response.statusText}`;
                        }

                        console.error('Fehler beim QR-Code-Upload:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('QR-Code-Upload erfolgreich:', result);

                    // QR-Code anzeigen
                    await loadQrCode(professionId);
                    showAlert(professionAlert, 'QR-Code erfolgreich hochgeladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Hochladen des QR-Codes:', error);
                    showAlert(professionAlert, 'Fehler beim Hochladen des QR-Codes: ' + error.message, 'danger');
                } finally {
                    qrUploadProgress.style.display = 'none';
                    qrUpload.value = ''; // Reset input
                }
            }

            // CRUD-Funktionen f√ºr Kategorien
            async function loadCategories() {
                try {
                    categoriesList.innerHTML = '<tr><td colspan="3">Kategorien werden geladen...</td></tr>';
                    categories = await cmsApi.getCategories();
                    renderCategories();
                    showAlert(categoryAlert, 'Kategorien erfolgreich geladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Laden der Kategorien:', error);
                    categoriesList.innerHTML = '<tr><td colspan="3">Fehler beim Laden der Kategorien.</td></tr>';
                    showAlert(categoryAlert, 'Fehler beim Laden der Kategorien: ' + error.message, 'danger');
                }
            }

            function renderCategories() {
                if (categories.length === 0) {
                    categoriesList.innerHTML = '<tr><td colspan="3">Keine Kategorien gefunden.</td></tr>';
                    return;
                }

                categoriesList.innerHTML = '';
                categories.forEach(category => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.id}</td>
                        <td>${category.name}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm edit-category" data-id="${category.id}">Bearbeiten</button>
                            <button class="btn btn-danger btn-sm delete-category" data-id="${category.id}">L√∂schen</button>
                        </td>
                    `;
                    categoriesList.appendChild(row);
                });

                // Event-Listener f√ºr Bearbeiten-Buttons
                document.querySelectorAll('.edit-category').forEach(button => {
                    button.addEventListener('click', function () {
                        const categoryId = this.dataset.id;
                        const category = categories.find(c => c.id === categoryId);

                        if (category) {
                            currentMode = 'edit';
                            currentCategoryId = categoryId;
                            document.getElementById('categoryModalTitle').textContent = 'Kategorie bearbeiten';
                            document.getElementById('categoryId').value = category.id;
                            document.getElementById('categoryId').disabled = true; // ID kann nicht ge√§ndert werden
                            document.getElementById('categoryName').value = category.name;
                            openModal(categoryModal);
                        }
                    });
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', function () {
                        const categoryId = this.dataset.id;
                        if (confirm(`M√∂chten Sie die Kategorie "${categoryId}" wirklich l√∂schen?`)) {
                            deleteCategory(categoryId);
                        }
                    });
                });
            }

            async function saveCategory() {
                const categoryId = document.getElementById('categoryId').value.trim();
                const categoryName = document.getElementById('categoryName').value.trim();

                if (!categoryId || !categoryName) {
                    showAlert(categoryAlert, 'ID und Name sind erforderlich.', 'danger');
                    return;
                }

                try {
                    const category = {
                        id: categoryId,
                        name: categoryName,
                        isNew: currentMode === 'add'
                    };

                    await cmsApi.saveCategory(category);
                    closeModal(categoryModal);
                    loadCategories();
                    showAlert(categoryAlert, `Kategorie erfolgreich ${currentMode === 'add' ? 'erstellt' : 'aktualisiert'}.`, 'success');
                } catch (error) {
                    console.error('Fehler beim Speichern der Kategorie:', error);
                    showAlert(categoryAlert, 'Fehler beim Speichern der Kategorie: ' + error.message, 'danger');
                }
            }

            async function deleteCategory(categoryId) {
                try {
                    await cmsApi.deleteCategory(categoryId);
                    loadCategories();
                    showAlert(categoryAlert, 'Kategorie erfolgreich gel√∂scht.', 'success');
                } catch (error) {
                    console.error('Fehler beim L√∂schen der Kategorie:', error);
                    showAlert(categoryAlert, 'Fehler beim L√∂schen der Kategorie: ' + error.message, 'danger');
                }
            }

            // CRUD-Funktionen f√ºr Berufe
            async function loadProfessions() {
                try {
                    professionsList.innerHTML = '<tr><td colspan="4">Berufe werden geladen...</td></tr>';
                    professions = await cmsApi.getProfessions();
                    renderProfessions();
                    showAlert(professionAlert, 'Berufe erfolgreich geladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Laden der Berufe:', error);
                    professionsList.innerHTML = '<tr><td colspan="4">Fehler beim Laden der Berufe.</td></tr>';
                    showAlert(professionAlert, 'Fehler beim Laden der Berufe: ' + error.message, 'danger');
                }
            }

            function renderProfessions() {
                if (professions.length === 0) {
                    professionsList.innerHTML = '<tr><td colspan="4">Keine Berufe gefunden.</td></tr>';
                    return;
                }

                professionsList.innerHTML = '';
                professions.forEach(profession => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${profession.title}</td>
                        <td>${profession.category_name || profession.category_id}</td>
                        <td>${profession.duration}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm edit-profession" data-id="${profession.id}">Bearbeiten</button>
                            <button class="btn btn-danger btn-sm delete-profession" data-id="${profession.id}">L√∂schen</button>
                        </td>
                    `;
                    professionsList.appendChild(row);
                });

                // Event-Listener f√ºr Bearbeiten-Buttons
                document.querySelectorAll('.edit-profession').forEach(button => {
                    button.addEventListener('click', function () {
                        const professionId = this.dataset.id;
                        editProfession(professionId);
                    });
                });

                // Event-Listener f√ºr L√∂sch-Buttons
                document.querySelectorAll('.delete-profession').forEach(button => {
                    button.addEventListener('click', function () {
                        const professionId = this.dataset.id;
                        const profession = professions.find(p => p.id === professionId);
                        if (confirm(`M√∂chten Sie den Beruf "${profession.title}" wirklich l√∂schen?`)) {
                            deleteProfession(professionId);
                        }
                    });
                });
            }

            async function loadCategoriesForSelect() {
                try {
                    if (categories.length === 0) {
                        categories = await cmsApi.getCategories();
                    }

                    professionCategory.innerHTML = '';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        professionCategory.appendChild(option);
                    });
                } catch (error) {
                    console.error('Fehler beim Laden der Kategorien f√ºr das Dropdown:', error);
                    showAlert(professionAlert, 'Fehler beim Laden der Kategorien: ' + error.message, 'danger');
                }
            }

            async function editProfession(professionId) {
                try {
                    const profession = await cmsApi.getProfession(professionId);

                    currentMode = 'edit';
                    currentProfessionId = professionId;
                    document.getElementById('professionModalTitle').textContent = 'Ausbildungsberuf bearbeiten';
                    document.getElementById('professionId').value = profession.id;
                    document.getElementById('professionId').disabled = true; // ID kann nicht ge√§ndert werden
                    document.getElementById('professionTitle').value = profession.title;
                    document.getElementById('professionDescription').value = profession.description;
                    document.getElementById('professionDuration').value = profession.duration;
                    document.getElementById('hasKnowledgeTest').checked = profession.has_knowledge_test;

                    // Kategorien laden und Vorauswahl setzen
                    await loadCategoriesForSelect();
                    document.getElementById('professionCategory').value = profession.category_id;

                    // Listen laden
                    requirements = profession.requirements || [];
                    careerOptions = profession.career_options || [];
                    locations = profession.locations || [];
                    renderRequirements();
                    renderCareerOptions();
                    renderLocations();

                    // Bilder und QR-Code laden
                    renderGalleryImages(profession.gallery_images || []);
                    if (profession.qr_code) {
                        qrPreviewImage.src = profession.qr_code;
                        qrPreview.style.display = 'block';
                        noQrMessage.style.display = 'none';
                    } else {
                        resetQrCode();
                    }

                    openModal(professionModal);
                } catch (error) {
                    console.error('Fehler beim Laden des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim Laden des Berufs: ' + error.message, 'danger');
                }
            }

            async function saveProfession() {
                const professionId = document.getElementById('professionId').value.trim();
                const professionTitle = document.getElementById('professionTitle').value.trim();
                const professionDescription = document.getElementById('professionDescription').value.trim();
                const professionDuration = document.getElementById('professionDuration').value.trim();
                const categoryId = document.getElementById('professionCategory').value;
                const hasKnowledgeTest = document.getElementById('hasKnowledgeTest').checked;

                if (!professionId || !professionTitle || !professionDescription || !professionDuration || !categoryId) {
                    showAlert(professionAlert, 'Alle Pflichtfelder m√ºssen ausgef√ºllt sein.', 'danger');
                    return;
                }

                try {
                    const profession = {
                        id: professionId,
                        title: professionTitle,
                        description: professionDescription,
                        duration: professionDuration,
                        category: categoryId,
                        has_knowledge_test: hasKnowledgeTest,
                        requirements: requirements,
                        career_options: careerOptions,
                        locations: locations
                    };

                    await cmsApi.saveProfession(profession);

                    if (currentMode === 'add') {
                        // Wechsel zum Galerie-Tab nach dem ersten Speichern eines neuen Berufs
                        document.querySelector('.form-tab.active').classList.remove('active');
                        document.querySelector('.form-tab[data-section="gallery"]').classList.add('active');
                        document.querySelector('.form-section.active').classList.remove('active');
                        document.getElementById('gallerySection').classList.add('active');

                        // Setze currentMode auf 'edit', damit der Benutzer nun Bilder hochladen kann
                        currentMode = 'edit';
                        document.getElementById('professionId').disabled = true;
                        showAlert(professionAlert, 'Beruf erfolgreich erstellt. Sie k√∂nnen jetzt Bilder hochladen.', 'success');
                    } else {
                        closeModal(professionModal);
                        loadProfessions();
                        showAlert(professionAlert, 'Beruf erfolgreich aktualisiert.', 'success');
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim Speichern des Berufs: ' + error.message, 'danger');
                }

                async function saveQuizQuestions(professionId) {
                    if (!professionId || !hasKnowledgeTest.checked) {
                        return;
                    }

                    // Validieren der Daten
                    const invalidQuestions = quizQuestionsData.filter(q =>
                        !q.text ||
                        q.options.some(o => !o.text) ||
                        !q.options.some(o => o.isCorrect)
                    );

                    if (invalidQuestions.length > 0) {
                        throw new Error(`Bitte f√ºllen Sie alle Felder aus und w√§hlen Sie jeweils eine richtige Antwort f√ºr jede Frage aus.`);
                    }

                    try {
                        await cmsApi.saveQuizQuestions(professionId, quizQuestionsData);
                    } catch (error) {
                        console.error('Fehler beim Speichern der Wissenstest-Fragen:', error);
                        throw error;
                    }
                }
                const originalEditProfession = editProfession;
                editProfession = async function (professionId) {
                    await originalEditProfession(professionId);

                    // Wissenstest-Tab ein-/ausblenden basierend auf dem Checkbox-Status
                    const hasTest = document.getElementById('hasKnowledgeTest').checked;
                    toggleQuizTab(hasTest);

                    // Wissenstest-Daten laden
                    await loadQuizQuestions(professionId);
                };

                const originalSaveProfession = saveProfession;
                saveProfession = async function () {
                    try {
                        await originalSaveProfession();

                        // Wenn erfolgreich gespeichert und Wissenstest aktiviert, dann auch Wissenstest speichern
                        const professionId = document.getElementById('professionId').value.trim();
                        const hasTest = document.getElementById('hasKnowledgeTest').checked;

                        if (hasTest && professionId) {
                            await saveQuizQuestions(professionId);
                        }
                    } catch (error) {
                        console.error('Fehler beim Speichern:', error);
                        showAlert(professionAlert, error.message, 'danger');
                    }
                };
            }

            async function deleteProfession(professionId) {
                try {
                    await cmsApi.deleteProfession(professionId);
                    loadProfessions();
                    showAlert(professionAlert, 'Beruf erfolgreich gel√∂scht.', 'success');
                } catch (error) {
                    console.error('Fehler beim L√∂schen des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim L√∂schen des Berufs: ' + error.message, 'danger');
                }
            }

            // Helfer-Funktion zum Anzeigen von Alerts
            function showAlert(alertElement, message, type) {
                alertElement.innerHTML = `<div class="alert-icon">${type === 'success' ? '‚úì' : '‚ö†'}</div>${message}`;
                alertElement.className = `alert alert-${type}`;
                alertElement.style.display = 'flex';

                // Alert nach 5 Sekunden ausblenden
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }

            // Event-Listener f√ºr Formular-Buttons
            saveCategoryBtn.addEventListener('click', saveCategory);
            saveProfessionBtn.addEventListener('click', saveProfession);

            // Initial laden
            loadCategories();
            loadProfessions();

            // Quiz-bezogene DOM-Elemente
            const quizTab = document.getElementById('quizTab');
            const quizSection = document.getElementById('quizSection');
            const hasKnowledgeTest = document.getElementById('hasKnowledgeTest');
            const addQuestionBtn = document.getElementById('addQuestionBtn');
            const quizQuestions = document.getElementById('quizQuestions');
            const questionTemplate = document.getElementById('questionTemplate');

            // Quiz-Status
            let quizQuestionsData = [];
            const MAX_QUESTIONS = 5;

            // Event-Listener f√ºr die Checkbox "Hat Wissenstest"
            hasKnowledgeTest.addEventListener('change', function () {
                toggleQuizTab(this.checked);
            });

            // Tab ein-/ausblenden basierend auf Checkbox-Status
            function toggleQuizTab(show) {
                quizTab.style.display = show ? 'block' : 'none';

                // Wenn der Tab ausgeblendet wird, auch die Sektion ausblenden
                if (!show && quizSection.classList.contains('active')) {
                    // Zur√ºck zum ersten Tab wechseln
                    document.querySelector('.form-tab[data-section="general"]').click();
                }

                // Wenn wieder eingeblendet und noch keine Fragen da sind, eine leere erstellen
                if (show && quizQuestionsData.length === 0) {
                    addQuestion();
                }

                // "Weitere Frage hinzuf√ºgen"-Button nur anzeigen, wenn weniger als MAX_QUESTIONS
                updateAddQuestionButton();
            }

            // Frage hinzuf√ºgen
            function addQuestion() {
                if (quizQuestionsData.length >= MAX_QUESTIONS) {
                    return;
                }

                // Neue Frage erstellen
                const newQuestion = {
                    id: Date.now(), // Tempor√§re ID f√ºr die UI
                    text: '',
                    explanation: '',
                    options: [
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false }
                    ]
                };

                quizQuestionsData.push(newQuestion);
                renderQuizQuestions();
                updateAddQuestionButton();
            }

            // Frage l√∂schen
            function deleteQuestion(questionId) {
                quizQuestionsData = quizQuestionsData.filter(q => q.id !== questionId);
                renderQuizQuestions();
                updateAddQuestionButton();

                // Wenn keine Fragen mehr da sind, eine leere erstellen
                if (quizQuestionsData.length === 0 && hasKnowledgeTest.checked) {
                    addQuestion();
                }
            }

            // "Weitere Frage hinzuf√ºgen"-Button aktualisieren
            function updateAddQuestionButton() {
                if (quizQuestionsData.length < MAX_QUESTIONS && hasKnowledgeTest.checked) {
                    addQuestionBtn.style.display = 'block';
                } else {
                    addQuestionBtn.style.display = 'none';
                }
            }

            // Alle Wissenstest-Fragen rendern
            function renderQuizQuestions() {
                quizQuestions.innerHTML = '';

                quizQuestionsData.forEach((question, index) => {
                    // Template klonen
                    const questionEl = document.importNode(questionTemplate.content, true).querySelector('.quiz-question');

                    // Fragennummer setzen
                    questionEl.querySelector('.question-number').textContent = index + 1;

                    // Fragetext und Erkl√§rung setzen
                    questionEl.querySelector('.question-text').value = question.text || '';
                    questionEl.querySelector('.question-explanation').value = question.explanation || '';

                    // Radio-Button-Gruppe eindeutig machen
                    const radioGroup = `correct-${question.id}`;
                    const radioInputs = questionEl.querySelectorAll('.correct-answer');
                    radioInputs.forEach((radio, i) => {
                        radio.name = radioGroup;
                        radio.checked = question.options[i] && question.options[i].isCorrect;
                    });

                    // Antworttexte setzen
                    const answerInputs = questionEl.querySelectorAll('.answer-text');
                    answerInputs.forEach((input, i) => {
                        input.value = question.options[i] ? question.options[i].text : '';
                    });

                    // Event-Listener f√ºr √Ñnderungen
                    questionEl.querySelector('.question-text').addEventListener('input', function (e) {
                        question.text = e.target.value;
                    });

                    questionEl.querySelector('.question-explanation').addEventListener('input', function (e) {
                        question.explanation = e.target.value;
                    });

                    answerInputs.forEach((input, i) => {
                        input.addEventListener('input', function (e) {
                            question.options[i].text = e.target.value;
                        });
                    });

                    radioInputs.forEach((radio, i) => {
                        radio.addEventListener('change', function () {
                            // Alle auf false setzen
                            question.options.forEach(option => option.isCorrect = false);
                            // Nur die ausgew√§hlte auf true setzen
                            question.options[i].isCorrect = true;
                        });
                    });

                    // L√∂sch-Button Event-Listener
                    questionEl.querySelector('.delete-question').addEventListener('click', function () {
                        if (confirm('M√∂chten Sie diese Frage wirklich l√∂schen?')) {
                            deleteQuestion(question.id);
                        }
                    });

                    // Element zum Container hinzuf√ºgen
                    quizQuestions.appendChild(questionEl);
                });
            }

            // Wissenstest-Daten laden
            async function loadQuizQuestions(professionId) {
                if (!professionId) {
                    quizQuestionsData = [];
                    renderQuizQuestions();
                    return;
                }

                try {
                    const questions = await cmsApi.getQuizQuestions(professionId);
                    quizQuestionsData = questions;

                    // Wenn keine Fragen gefunden wurden, aber Wissenstest aktiviert ist, eine leere erstellen
                    if (quizQuestionsData.length === 0 && hasKnowledgeTest.checked) {
                        addQuestion();
                    } else {
                        renderQuizQuestions();
                    }

                    updateAddQuestionButton();
                } catch (error) {
                    console.error('Fehler beim Laden der Wissenstest-Fragen:', error);
                    showAlert(professionAlert, 'Fehler beim Laden der Wissenstest-Fragen: ' + error.message, 'danger');
                }
            }
            addQuestionBtn.addEventListener('click', addQuestion);

        });
    </script>
</body>

</html>