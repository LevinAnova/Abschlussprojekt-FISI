<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VW Ausbildung - Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Inline-CSS für das Modal-Problem und zusätzliche Styling für Bild-Upload -->
    <style>
        /* Modal-Styling für Scrollbarkeit */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            position: relative;
            max-height: calc(100vh - 40px); /* 40px als Padding */
            display: flex;
            flex-direction: column;
            margin: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto; /* Scrollbar für Inhalt */
            max-height: calc(100vh - 180px); /* Platz für Header und Footer */
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }

        /* Verbesserte Mobile-Ansicht */
        @media (max-height: 768px) {
            .modal {
                height: calc(100vh - 40px);
            }
            
            .modal-body {
                max-height: none;
                flex-grow: 1;
            }
        }

        /* Styling für Formulartabs */
        .form-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .form-tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }

        .form-tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
            color: #001e50;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        /* Styling für Bild-Upload und Gallerie */
        .upload-area {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #4cc0f1;
            background: #f0f9ff;
        }

        .upload-icon {
            font-size: 40px;
            color: #777;
            margin-bottom: 10px;
        }

        .gallery-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gallery-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            height: 150px;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-preview {
            max-width: 250px;
            margin: 20px auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .qr-preview img {
            width: 100%;
            height: auto;
        }

        #imageUpload, #qrUpload {
            display: none;
        }

        .file-info {
            font-size: 14px;
            color: #777;
            margin-top: 10px;
        }

        /* Spinner für Laden */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #001e50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        .header-title {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="js/cms.js" defer></script>
</head>
<body>
    <header>
        <div class="header-container container">
            <img src="img/vwlogo.png" alt="Volkswagen Logo" class="logo">
            <h1 class="header-title">Ausbildungsberufe - Administration</h1>
        </div>
    </header>

    <main class="container">
        <!-- Navigation Tabs -->
        <ul class="tabs" id="adminTabs">
            <li class="tab-item active" data-tab="categories">Kategorien</li>
            <li class="tab-item" data-tab="professions">Ausbildungsberufe</li>
        </ul>

        <!-- Kategorien-Verwaltung -->
        <section id="categoriesSection" class="content-section active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Kategorien verwalten</h2>
                    <button id="addCategoryBtn" class="btn btn-primary btn-sm">Neue Kategorie</button>
                </div>
                <div class="card-body">
                    <div id="categoryAlert" class="alert" style="display: none;"></div>
                    <table class="table" id="categoriesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesList">
                            <!-- Kategorien werden hier eingefügt -->
                            <tr>
                                <td colspan="3">Kategorien werden geladen...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Berufe-Verwaltung -->
        <section id="professionsSection" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ausbildungsberufe verwalten</h2>
                    <button id="addProfessionBtn" class="btn btn-primary btn-sm">Neuer Beruf</button>
                </div>
                <div class="card-body">
                    <div id="professionAlert" class="alert" style="display: none;"></div>
                    <table class="table" id="professionsTable">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Kategorie</th>
                                <th>Ausbildungsdauer</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="professionsList">
                            <!-- Berufe werden hier eingefügt -->
                            <tr>
                                <td colspan="4">Berufe werden geladen...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Modals -->
        <!-- Kategorie Modal -->
        <div class="modal-overlay" id="categoryModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="categoryModalTitle">Kategorie hinzufügen</h3>
                    <button class="modal-close" id="closeCategoryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="form-group">
                            <label for="categoryId" class="form-label">ID (Kurzname/Slug)</label>
                            <input type="text" id="categoryId" class="form-control" required>
                            <small>Nur Kleinbuchstaben, Zahlen und Bindestriche, z.B. "it-elektronik"</small>
                        </div>
                        <div class="form-group">
                            <label for="categoryName" class="form-label">Name</label>
                            <input type="text" id="categoryName" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelCategoryBtn">Abbrechen</button>
                    <button class="btn btn-primary" id="saveCategoryBtn">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Beruf Modal -->
        <div class="modal-overlay" id="professionModal">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="professionModalTitle">Ausbildungsberuf hinzufügen</h3>
                    <button class="modal-close" id="closeProfessionModal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Tabs für die verschiedenen Abschnitte -->
                    <div class="form-tabs">
                        <div class="form-tab active" data-section="general">Allgemeine Infos</div>
                        <div class="form-tab" data-section="gallery">Galerie-Bilder</div>
                        <div class="form-tab" data-section="qrcode">QR-Code</div>
                    </div>

                    <form id="professionForm">
                        <!-- Allgemeine Informationen -->
                        <div class="form-section active" id="generalSection">
                            <div class="form-group">
                                <label for="professionId" class="form-label">ID (Kurzname/Slug)</label>
                                <input type="text" id="professionId" class="form-control" required>
                                <small>Nur Kleinbuchstaben, Zahlen und Bindestriche, z.B. "fachinformatiker-si"</small>
                            </div>
                            <div class="form-group">
                                <label for="professionTitle" class="form-label">Titel</label>
                                <input type="text" id="professionTitle" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="professionCategory" class="form-label">Kategorie</label>
                                <select id="professionCategory" class="form-control" required>
                                    <!-- Kategorien werden hier eingefügt -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="professionDuration" class="form-label">Ausbildungsdauer</label>
                                <input type="text" id="professionDuration" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="professionDescription" class="form-label">Beschreibung</label>
                                <textarea id="professionDescription" class="form-control" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anforderungen</label>
                                <div class="list-manager" id="requirementsManager">
                                    <div id="requirementsList">
                                        <!-- Anforderungen werden hier eingefügt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newRequirement" placeholder="Neue Anforderung hinzufügen">
                                        <button type="button" class="btn btn-secondary" id="addRequirementBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Karrieremöglichkeiten</label>
                                <div class="list-manager" id="careerOptionsManager">
                                    <div id="careerOptionsList">
                                        <!-- Karrieremöglichkeiten werden hier eingefügt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newCareerOption" placeholder="Neue Karrieremöglichkeit hinzufügen">
                                        <button type="button" class="btn btn-secondary" id="addCareerOptionBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Standorte</label>
                                <div class="list-manager" id="locationsManager">
                                    <div id="locationsList">
                                        <!-- Standorte werden hier eingefügt -->
                                    </div>
                                    <div class="add-item-form">
                                        <input type="text" class="form-control" id="newLocation" placeholder="Neuen Standort hinzufügen">
                                        <button type="button" class="btn btn-secondary" id="addLocationBtn">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" id="hasKnowledgeTest"> Hat Wissenstest
                                </label>
                            </div>
                        </div>

                        <!-- Galerie-Bilder -->
                        <div class="form-section" id="gallerySection">
                            <div class="form-group">
                                <label class="form-label">Galerie-Bilder hochladen</label>
                                <div class="upload-area" id="galleryUploadArea">
                                    <div class="upload-icon">📸</div>
                                    <p>Klicken Sie hier, um Bilder hochzuladen<br>oder ziehen Sie Bilder hierher</p>
                                    <p class="file-info">Maximal 5MB pro Datei. Erlaubte Formate: JPG, PNG, GIF</p>
                                    <input type="file" id="imageUpload" accept="image/*">
                                </div>
                                <div id="uploadProgress" style="display: none;">
                                    <div class="spinner"></div> <span>Bild wird hochgeladen...</span>
                                </div>
                            </div>
                            
                            <div id="galleryImagesContainer" class="gallery-preview">
                                <!-- Gallerie-Bilder werden hier angezeigt -->
                                <div id="noImagesMessage" style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #777;">
                                    Keine Bilder vorhanden. Laden Sie Bilder hoch, um sie in der Galerie anzuzeigen.
                                </div>
                            </div>
                        </div>

                        <!-- QR-Code -->
                        <div class="form-section" id="qrcodeSection">
                            <div class="form-group">
                                <label class="form-label">QR-Code für Bewerbungslink</label>
                                <div class="upload-area" id="qrUploadArea">
                                    <div class="upload-icon">🔗</div>
                                    <p>Klicken Sie hier, um einen QR-Code hochzuladen<br>oder ziehen Sie die Datei hierher</p>
                                    <p class="file-info">Maximal 5MB. Erlaubte Formate: JPG, PNG, SVG</p>
                                    <input type="file" id="qrUpload" accept="image/*">
                                </div>
                                <div id="qrUploadProgress" style="display: none;">
                                    <div class="spinner"></div> <span>QR-Code wird hochgeladen...</span>
                                </div>
                            </div>
                            
                            <div id="qrPreview" class="qr-preview" style="display: none;">
                                <h4 style="text-align: center; margin-bottom: 10px;">Vorschau:</h4>
                                <img id="qrPreviewImage" src="" alt="QR-Code Vorschau">
                                <button id="removeQrBtn" class="btn btn-danger btn-sm" style="display: block; margin: 10px auto 0;">QR-Code entfernen</button>
                            </div>
                            <div id="noQrMessage" style="text-align: center; padding: 20px; color: #777;">
                                Kein QR-Code vorhanden. Laden Sie einen QR-Code hoch, um einen Bewerbungslink anzubieten.
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelProfessionBtn">Abbrechen</button>
                    <button class="btn btn-primary" id="saveProfessionBtn">Speichern</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variablen für den aktuellen State
            let categories = [];
            let professions = [];
            let currentMode = 'add'; // 'add' oder 'edit'
            let currentCategoryId = null;
            let currentProfessionId = null;
            let requirements = [];
            let careerOptions = [];
            let locations = [];
            let galleryImagesList = []; // Umbenannt von galleryImages zu galleryImagesList
            let qrCodeUrl = null;

            // DOM-Elemente
            const adminTabs = document.getElementById('adminTabs');
            const categoriesSection = document.getElementById('categoriesSection');
            const professionsSection = document.getElementById('professionsSection');
            const categoriesList = document.getElementById('categoriesList');
            const professionsList = document.getElementById('professionsList');
            const professionCategory = document.getElementById('professionCategory');
            
            // Modals
            const categoryModal = document.getElementById('categoryModal');
            const professionModal = document.getElementById('professionModal');
            
            // Forms
            const categoryForm = document.getElementById('categoryForm');
            const professionForm = document.getElementById('professionForm');
            
            // Buttons
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const addProfessionBtn = document.getElementById('addProfessionBtn');
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            const saveProfessionBtn = document.getElementById('saveProfessionBtn');
            const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
            const cancelProfessionBtn = document.getElementById('cancelProfessionBtn');
            const closeCategoryModal = document.getElementById('closeCategoryModal');
            const closeProfessionModal = document.getElementById('closeProfessionModal');
            const addRequirementBtn = document.getElementById('addRequirementBtn');
            const addCareerOptionBtn = document.getElementById('addCareerOptionBtn');
            const addLocationBtn = document.getElementById('addLocationBtn');
            
            // List containers
            const requirementsList = document.getElementById('requirementsList');
            const careerOptionsList = document.getElementById('careerOptionsList');
            const locationsList = document.getElementById('locationsList');
            
            // Alerts
            const categoryAlert = document.getElementById('categoryAlert');
            const professionAlert = document.getElementById('professionAlert');
            
            // Neue Elemente für Bilder und QR-Code
            const formTabs = document.querySelectorAll('.form-tab');
            const formSections = document.querySelectorAll('.form-section');
            const galleryUploadArea = document.getElementById('galleryUploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const qrUploadArea = document.getElementById('qrUploadArea');
            const qrUpload = document.getElementById('qrUpload');
            const galleryImagesContainer = document.getElementById('galleryImagesContainer'); // Umbenannt von galleryImages zu galleryImagesContainer
            const qrPreview = document.getElementById('qrPreview');
            const qrPreviewImage = document.getElementById('qrPreviewImage');
            const noQrMessage = document.getElementById('noQrMessage');
            const removeQrBtn = document.getElementById('removeQrBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const qrUploadProgress = document.getElementById('qrUploadProgress');

            // Form-Tabs Funktionalität
            formTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const activeTab = document.querySelector('.form-tab.active');
                    if (activeTab) {
                        activeTab.classList.remove('active');
                    }
                    
                    this.classList.add('active');
                    
                    const sectionName = this.dataset.section;
                    formSections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById(sectionName + 'Section').classList.add('active');
                });
            });

            // Tab-Wechsel
            adminTabs.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-item')) {
                    const activeTab = adminTabs.querySelector('.active');
                    if (activeTab) {
                        activeTab.classList.remove('active');
                    }
                    
                    e.target.classList.add('active');
                    
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    if (tabName === 'categories') {
                        categoriesSection.classList.add('active');
                    } else if (tabName === 'professions') {
                        professionsSection.classList.add('active');
                    }
                }
            });

            // Helfer-Funktionen für Modals
            function openModal(modal) {
                modal.classList.add('active');
            }
            
            function closeModal(modal) {
                modal.classList.remove('active');
            }
            
            // Kategorie-Modal öffnen/schließen
            addCategoryBtn.addEventListener('click', function() {
                currentMode = 'add';
                document.getElementById('categoryModalTitle').textContent = 'Kategorie hinzufügen';
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryId').disabled = false;
                document.getElementById('categoryName').value = '';
                openModal(categoryModal);
            });
            
            closeCategoryModal.addEventListener('click', function() {
                closeModal(categoryModal);
            });
            
            cancelCategoryBtn.addEventListener('click', function() {
                closeModal(categoryModal);
            });
            
            // Beruf-Modal öffnen/schließen
            addProfessionBtn.addEventListener('click', function() {
                currentMode = 'add';
                document.getElementById('professionModalTitle').textContent = 'Ausbildungsberuf hinzufügen';
                document.getElementById('professionId').value = '';
                document.getElementById('professionId').disabled = false;
                document.getElementById('professionTitle').value = '';
                document.getElementById('professionDescription').value = '';
                document.getElementById('professionDuration').value = '';
                document.getElementById('hasKnowledgeTest').checked = false;
                
                // Listen leeren
                requirements = [];
                careerOptions = [];
                locations = [];
                renderRequirements();
                renderCareerOptions();
                renderLocations();
                
                // Bilder und QR-Code zurücksetzen
                renderGalleryImages([]);
                resetQrCode();
                
                // Zum ersten Tab wechseln
                document.querySelector('.form-tab.active').classList.remove('active');
                document.querySelector('.form-tab[data-section="general"]').classList.add('active');
                document.querySelector('.form-section.active').classList.remove('active');
                document.getElementById('generalSection').classList.add('active');
                
                // Kategorien laden
                loadCategoriesForSelect();
                
                openModal(professionModal);
            });
            
            closeProfessionModal.addEventListener('click', function() {
                closeModal(professionModal);
            });
            
            cancelProfessionBtn.addEventListener('click', function() {
                closeModal(professionModal);
            });

            // Listen-Manager
            addRequirementBtn.addEventListener('click', function() {
                const input = document.getElementById('newRequirement');
                if (input.value.trim()) {
                    requirements.push(input.value.trim());
                    renderRequirements();
                    input.value = '';
                }
            });
            
            addCareerOptionBtn.addEventListener('click', function() {
                const input = document.getElementById('newCareerOption');
                if (input.value.trim()) {
                    careerOptions.push(input.value.trim());
                    renderCareerOptions();
                    input.value = '';
                }
            });
            
            addLocationBtn.addEventListener('click', function() {
                const input = document.getElementById('newLocation');
                if (input.value.trim()) {
                    locations.push(input.value.trim());
                    renderLocations();
                    input.value = '';
                }
            });
            
            function renderRequirements() {
                requirementsList.innerHTML = '';
                requirements.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-requirement" data-index="${index}">&times;</button>
                        </div>
                    `;
                    requirementsList.appendChild(listItem);
                });
                
                // Event-Listener für Lösch-Buttons
                document.querySelectorAll('.delete-requirement').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        requirements.splice(index, 1);
                        renderRequirements();
                    });
                });
            }
            
            function renderCareerOptions() {
                careerOptionsList.innerHTML = '';
                careerOptions.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-career-option" data-index="${index}">&times;</button>
                        </div>
                    `;
                    careerOptionsList.appendChild(listItem);
                });
                
                // Event-Listener für Lösch-Buttons
                document.querySelectorAll('.delete-career-option').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        careerOptions.splice(index, 1);
                        renderCareerOptions();
                    });
                });
            }
            
            function renderLocations() {
                locationsList.innerHTML = '';
                locations.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    listItem.innerHTML = `
                        <div class="list-item-content">${item}</div>
                        <div class="list-item-actions">
                            <button type="button" class="btn btn-danger btn-sm delete-location" data-index="${index}">&times;</button>
                        </div>
                    `;
                    locationsList.appendChild(listItem);
                });
                
                // Event-Listener für Lösch-Buttons
                document.querySelectorAll('.delete-location').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        locations.splice(index, 1);
                        renderLocations();
                    });
                });
            }
            
    // Funktionen für Bilder und QR-Code
    function renderGalleryImages(images) {
    const galleryContainer = galleryImagesContainer; // Verwende die umbenannte Variable
    const noImagesMessage = document.getElementById('noImagesMessage');
    
    if (!images || images.length === 0) {
        galleryContainer.innerHTML = '';
        galleryContainer.appendChild(noImagesMessage);
        noImagesMessage.style.display = 'block';
        return;
    }
    
    noImagesMessage.style.display = 'none';
    galleryContainer.innerHTML = '';
    
    images.forEach(image => {
        // Fehlerbehandlung für mögliche ungültige Bildobjekte
        if (!image || !image.url) {
            console.warn('Ungültiges Bildobjekt:', image);
            return;
        }
        
        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item';
        
        // Vollständige URL erstellen - stellen wir sicher, dass die URL korrekt ist
        const imageUrl = image.url.startsWith('http') ? image.url : 
                         image.url.startsWith('/') ? image.url : '/' + image.url;
        
        galleryItem.innerHTML = `
            <img src="${imageUrl}" alt="${image.alt_text || 'Galeriebild'}" 
                 onerror="this.src='/img/placeholder.jpg'; this.onerror=null;">
            <button class="delete-btn" data-id="${image.id}">&times;</button>
        `;
        galleryContainer.appendChild(galleryItem);
    });
    
    // Event-Listener für Lösch-Buttons
    document.querySelectorAll('.gallery-item .delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.dataset.id;
            if (confirm('Möchten Sie dieses Bild wirklich löschen?')) {
                deleteImage(imageId);
            }
        });
    });
}
            
            async function deleteImage(imageId) {
                try {
                    await cmsApi.deleteImage(imageId);
                    const professionId = document.getElementById('professionId').value;
                    loadGalleryImages(professionId);
                    showAlert(professionAlert, 'Bild erfolgreich gelöscht.', 'success');
                } catch (error) {
                    console.error('Fehler beim Löschen des Bildes:', error);
                    showAlert(professionAlert, 'Fehler beim Löschen des Bildes: ' + error.message, 'danger');
                }
            }
            
            async function loadGalleryImages(professionId) {
  if (!professionId) {
    console.warn('loadGalleryImages: Keine Berufs-ID angegeben');
    renderGalleryImages([]);
    return;
  }
  
  try {
    console.log('Lade Galerie-Bilder für Beruf:', professionId);
    const response = await fetch(`/api/professions/${professionId}`);
    
    if (!response.ok) {
      throw new Error(`Server-Fehler: ${response.status} ${response.statusText}`);
    }
    
    const profession = await response.json();
    console.log('Geladene Berufsdetails:', profession);
    
    if (profession && Array.isArray(profession.gallery_images)) {
      console.log('Gefundene Galerie-Bilder:', profession.gallery_images.length);
      renderGalleryImages(profession.gallery_images);
    } else {
      console.warn('Keine Galerie-Bilder gefunden für:', professionId);
      renderGalleryImages([]);
    }
  } catch (error) {
    console.error('Fehler beim Laden der Bilder:', error);
    renderGalleryImages([]);
    showAlert(professionAlert, 'Fehler beim Laden der Bilder: ' + error.message, 'danger');
  }
}           
            function resetQrCode() {
                qrPreview.style.display = 'none';
                qrPreviewImage.src = '';
                noQrMessage.style.display = 'block';
            }
            
            async function loadQrCode(professionId) {
                try {
                    const profession = await cmsApi.getProfession(professionId);
                    if (profession.qr_code) {
                        qrPreviewImage.src = profession.qr_code;
                        qrPreview.style.display = 'block';
                        noQrMessage.style.display = 'none';
                    } else {
                        resetQrCode();
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des QR-Codes:', error);
                    resetQrCode();
                }
            }
            
            // Event-Listener für Bild-Upload
            galleryUploadArea.addEventListener('click', function() {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    uploadGalleryImage(this.files[0]);
                }
            });
            
            // Drag & Drop für Gallerie-Bilder
            galleryUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#4cc0f1';
                this.style.backgroundColor = '#e6f7ff';
            });
            
            galleryUploadArea.addEventListener('dragleave', function() {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
            });
            
            galleryUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
                
                if (e.dataTransfer.files.length > 0) {
                    uploadGalleryImage(e.dataTransfer.files[0]);
                }
            });
            
async function uploadGalleryImage(file) {
  const professionId = document.getElementById('professionId').value;
  if (!professionId) {
    showAlert(professionAlert, 'Bitte speichern Sie zuerst den Beruf, bevor Sie Bilder hochladen.', 'danger');
    return;
  }
  
  uploadProgress.style.display = 'block';
  
  try {
    console.log('Starte Bild-Upload für Beruf:', professionId);
    
    // Formular für Datei-Upload erstellen
    const formData = new FormData();
    formData.append('file', file);
    
    // Direkter Fetch-Aufruf zum API-Endpunkt
    const response = await fetch(`/api/professions/${professionId}/images`, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Server-Antwort:', response.status, errorText);
      throw new Error(`Server-Fehler: ${response.status} ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('Bild-Upload-Ergebnis:', result);
    
    // Nach erfolgreichem Upload die Bilder neu laden
    await loadGalleryImages(professionId);
    showAlert(professionAlert, 'Bild erfolgreich hochgeladen.', 'success');
  } catch (error) {
    console.error('Fehler beim Hochladen des Bildes:', error);
    showAlert(professionAlert, 'Fehler beim Hochladen des Bildes: ' + error.message, 'danger');
  } finally {
    uploadProgress.style.display = 'none';
    imageUpload.value = ''; // Reset input
  }
}
            
            // Event-Listener für QR-Code-Upload
            qrUploadArea.addEventListener('click', function() {
                qrUpload.click();
            });
            
            qrUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    uploadQrCode(this.files[0]);
                }
            });
            
            // Drag & Drop für QR-Code
            qrUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#4cc0f1';
                this.style.backgroundColor = '#e6f7ff';
            });
            
            qrUploadArea.addEventListener('dragleave', function() {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
            });
            
            qrUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '#f9f9f9';
                
                if (e.dataTransfer.files.length > 0) {
                    uploadQrCode(e.dataTransfer.files[0]);
                }
            });
            
            async function uploadQrCode(file) {
                const professionId = document.getElementById('professionId').value;
                if (!professionId) {
                    showAlert(professionAlert, 'Bitte speichern Sie zuerst den Beruf, bevor Sie einen QR-Code hochladen.', 'danger');
                    return;
                }
                
                qrUploadProgress.style.display = 'block';
                
                try {
                    await cmsApi.uploadImage(professionId, file, null, true); // true für QR-Code
                    await loadQrCode(professionId);
                    showAlert(professionAlert, 'QR-Code erfolgreich hochgeladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Hochladen des QR-Codes:', error);
                    showAlert(professionAlert, 'Fehler beim Hochladen des QR-Codes: ' + error.message, 'danger');
                } finally {
                    qrUploadProgress.style.display = 'none';
                    qrUpload.value = ''; // Reset input
                }
            }
            
            removeQrBtn.addEventListener('click', async function() {
  if (confirm('Möchten Sie den QR-Code wirklich entfernen?')) {
    try {
      const professionId = document.getElementById('professionId').value;
      await cmsApi.deleteQrCode(professionId);
      resetQrCode();
      showAlert(professionAlert, 'QR-Code erfolgreich entfernt.', 'success');
    } catch (error) {
      console.error('Fehler beim Löschen des QR-Codes:', error);
      showAlert(professionAlert, 'Fehler beim Löschen des QR-Codes: ' + error.message, 'danger');
    }
  }
});

            // CRUD-Funktionen für Kategorien
            async function loadCategories() {
                try {
                    categoriesList.innerHTML = '<tr><td colspan="3">Kategorien werden geladen...</td></tr>';
                    categories = await cmsApi.getCategories();
                    renderCategories();
                    showAlert(categoryAlert, 'Kategorien erfolgreich geladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Laden der Kategorien:', error);
                    categoriesList.innerHTML = '<tr><td colspan="3">Fehler beim Laden der Kategorien.</td></tr>';
                    showAlert(categoryAlert, 'Fehler beim Laden der Kategorien: ' + error.message, 'danger');
                }
            }
            
            function renderCategories() {
                if (categories.length === 0) {
                    categoriesList.innerHTML = '<tr><td colspan="3">Keine Kategorien gefunden.</td></tr>';
                    return;
                }
                
                categoriesList.innerHTML = '';
                categories.forEach(category => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.id}</td>
                        <td>${category.name}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm edit-category" data-id="${category.id}">Bearbeiten</button>
                            <button class="btn btn-danger btn-sm delete-category" data-id="${category.id}">Löschen</button>
                        </td>
                    `;
                    categoriesList.appendChild(row);
                });
                
                // Event-Listener für Bearbeiten-Buttons
                document.querySelectorAll('.edit-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const categoryId = this.dataset.id;
                        const category = categories.find(c => c.id === categoryId);
                        
                        if (category) {
                            currentMode = 'edit';
                            currentCategoryId = categoryId;
                            document.getElementById('categoryModalTitle').textContent = 'Kategorie bearbeiten';
                            document.getElementById('categoryId').value = category.id;
                            document.getElementById('categoryId').disabled = true; // ID kann nicht geändert werden
                            document.getElementById('categoryName').value = category.name;
                            openModal(categoryModal);
                        }
                    });
                });
                
                // Event-Listener für Lösch-Buttons
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const categoryId = this.dataset.id;
                        if (confirm(`Möchten Sie die Kategorie "${categoryId}" wirklich löschen?`)) {
                            deleteCategory(categoryId);
                        }
                    });
                });
            }
            
            async function saveCategory() {
                const categoryId = document.getElementById('categoryId').value.trim();
                const categoryName = document.getElementById('categoryName').value.trim();
                
                if (!categoryId || !categoryName) {
                    showAlert(categoryAlert, 'ID und Name sind erforderlich.', 'danger');
                    return;
                }
                
                try {
                    const category = {
                        id: categoryId,
                        name: categoryName,
                        isNew: currentMode === 'add'
                    };
                    
                    await cmsApi.saveCategory(category);
                    closeModal(categoryModal);
                    loadCategories();
                    showAlert(categoryAlert, `Kategorie erfolgreich ${currentMode === 'add' ? 'erstellt' : 'aktualisiert'}.`, 'success');
                } catch (error) {
                    console.error('Fehler beim Speichern der Kategorie:', error);
                    showAlert(categoryAlert, 'Fehler beim Speichern der Kategorie: ' + error.message, 'danger');
                }
            }
            
            async function deleteCategory(categoryId) {
                try {
                    await cmsApi.deleteCategory(categoryId);
                    loadCategories();
                    showAlert(categoryAlert, 'Kategorie erfolgreich gelöscht.', 'success');
                } catch (error) {
                    console.error('Fehler beim Löschen der Kategorie:', error);
                    showAlert(categoryAlert, 'Fehler beim Löschen der Kategorie: ' + error.message, 'danger');
                }
            }
            
            // CRUD-Funktionen für Berufe
            async function loadProfessions() {
                try {
                    professionsList.innerHTML = '<tr><td colspan="4">Berufe werden geladen...</td></tr>';
                    professions = await cmsApi.getProfessions();
                    renderProfessions();
                    showAlert(professionAlert, 'Berufe erfolgreich geladen.', 'success');
                } catch (error) {
                    console.error('Fehler beim Laden der Berufe:', error);
                    professionsList.innerHTML = '<tr><td colspan="4">Fehler beim Laden der Berufe.</td></tr>';
                    showAlert(professionAlert, 'Fehler beim Laden der Berufe: ' + error.message, 'danger');
                }
            }
            
            function renderProfessions() {
                if (professions.length === 0) {
                    professionsList.innerHTML = '<tr><td colspan="4">Keine Berufe gefunden.</td></tr>';
                    return;
                }
                
                professionsList.innerHTML = '';
                professions.forEach(profession => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${profession.title}</td>
                        <td>${profession.category_name || profession.category_id}</td>
                        <td>${profession.duration}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm edit-profession" data-id="${profession.id}">Bearbeiten</button>
                            <button class="btn btn-danger btn-sm delete-profession" data-id="${profession.id}">Löschen</button>
                        </td>
                    `;
                    professionsList.appendChild(row);
                });
                
                // Event-Listener für Bearbeiten-Buttons
                document.querySelectorAll('.edit-profession').forEach(button => {
                    button.addEventListener('click', function() {
                        const professionId = this.dataset.id;
                        editProfession(professionId);
                    });
                });
                
                // Event-Listener für Lösch-Buttons
                document.querySelectorAll('.delete-profession').forEach(button => {
                    button.addEventListener('click', function() {
                        const professionId = this.dataset.id;
                        const profession = professions.find(p => p.id === professionId);
                        if (confirm(`Möchten Sie den Beruf "${profession.title}" wirklich löschen?`)) {
                            deleteProfession(professionId);
                        }
                    });
                });
            }
            
            async function loadCategoriesForSelect() {
                try {
                    if (categories.length === 0) {
                        categories = await cmsApi.getCategories();
                    }
                    
                    professionCategory.innerHTML = '';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        professionCategory.appendChild(option);
                    });
                } catch (error) {
                    console.error('Fehler beim Laden der Kategorien für das Dropdown:', error);
                    showAlert(professionAlert, 'Fehler beim Laden der Kategorien: ' + error.message, 'danger');
                }
            }
            
            async function editProfession(professionId) {
                try {
                    const profession = await cmsApi.getProfession(professionId);
                    
                    currentMode = 'edit';
                    currentProfessionId = professionId;
                    document.getElementById('professionModalTitle').textContent = 'Ausbildungsberuf bearbeiten';
                    document.getElementById('professionId').value = profession.id;
                    document.getElementById('professionId').disabled = true; // ID kann nicht geändert werden
                    document.getElementById('professionTitle').value = profession.title;
                    document.getElementById('professionDescription').value = profession.description;
                    document.getElementById('professionDuration').value = profession.duration;
                    document.getElementById('hasKnowledgeTest').checked = profession.has_knowledge_test;
                    
                    // Kategorien laden und Vorauswahl setzen
                    await loadCategoriesForSelect();
                    document.getElementById('professionCategory').value = profession.category_id;
                    
                    // Listen laden
                    requirements = profession.requirements || [];
                    careerOptions = profession.career_options || [];
                    locations = profession.locations || [];
                    renderRequirements();
                    renderCareerOptions();
                    renderLocations();
                    
                    // Bilder und QR-Code laden
                    renderGalleryImages(profession.gallery_images || []);
                    if (profession.qr_code) {
                        qrPreviewImage.src = profession.qr_code;
                        qrPreview.style.display = 'block';
                        noQrMessage.style.display = 'none';
                    } else {
                        resetQrCode();
                    }
                    
                    openModal(professionModal);
                } catch (error) {
                    console.error('Fehler beim Laden des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim Laden des Berufs: ' + error.message, 'danger');
                }
            }
            
            async function saveProfession() {
                const professionId = document.getElementById('professionId').value.trim();
                const professionTitle = document.getElementById('professionTitle').value.trim();
                const professionDescription = document.getElementById('professionDescription').value.trim();
                const professionDuration = document.getElementById('professionDuration').value.trim();
                const categoryId = document.getElementById('professionCategory').value;
                const hasKnowledgeTest = document.getElementById('hasKnowledgeTest').checked;
                
                if (!professionId || !professionTitle || !professionDescription || !professionDuration || !categoryId) {
                    showAlert(professionAlert, 'Alle Pflichtfelder müssen ausgefüllt sein.', 'danger');
                    return;
                }
                
                try {
                    const profession = {
                        id: professionId,
                        title: professionTitle,
                        description: professionDescription,
                        duration: professionDuration,
                        category: categoryId,
                        has_knowledge_test: hasKnowledgeTest,
                        requirements: requirements,
                        career_options: careerOptions,
                        locations: locations
                    };
                    
                    await cmsApi.saveProfession(profession);
                    
                    if (currentMode === 'add') {
                        // Wechsel zum Galerie-Tab nach dem ersten Speichern eines neuen Berufs
                        document.querySelector('.form-tab.active').classList.remove('active');
                        document.querySelector('.form-tab[data-section="gallery"]').classList.add('active');
                        document.querySelector('.form-section.active').classList.remove('active');
                        document.getElementById('gallerySection').classList.add('active');
                        
                        // Setze currentMode auf 'edit', damit der Benutzer nun Bilder hochladen kann
                        currentMode = 'edit';
                        document.getElementById('professionId').disabled = true;
                        showAlert(professionAlert, 'Beruf erfolgreich erstellt. Sie können jetzt Bilder hochladen.', 'success');
                    } else {
                        closeModal(professionModal);
                        loadProfessions();
                        showAlert(professionAlert, 'Beruf erfolgreich aktualisiert.', 'success');
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim Speichern des Berufs: ' + error.message, 'danger');
                }
            }
            
            async function deleteProfession(professionId) {
                try {
                    await cmsApi.deleteProfession(professionId);
                    loadProfessions();
                    showAlert(professionAlert, 'Beruf erfolgreich gelöscht.', 'success');
                } catch (error) {
                    console.error('Fehler beim Löschen des Berufs:', error);
                    showAlert(professionAlert, 'Fehler beim Löschen des Berufs: ' + error.message, 'danger');
                }
            }

            // Helfer-Funktion zum Anzeigen von Alerts
            function showAlert(alertElement, message, type) {
                alertElement.innerHTML = `<div class="alert-icon">${type === 'success' ? '✓' : '⚠'}</div>${message}`;
                alertElement.className = `alert alert-${type}`;
                alertElement.style.display = 'flex';
                
                // Alert nach 5 Sekunden ausblenden
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }

            // Event-Listener für Formular-Buttons
            saveCategoryBtn.addEventListener('click', saveCategory);
            saveProfessionBtn.addEventListener('click', saveProfession);

            // Initial laden
            loadCategories();
            loadProfessions();
        });
    </script>
</body>
</html>